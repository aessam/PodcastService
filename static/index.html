<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podcast Summary</title>
    
    <!-- React and dependencies -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    
    <style>
        body {
            background-color: #f8f9fa;
        }
        .input-field {
            width: 100%;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 16px;
        }
        .btn-primary {
            background-color: #4F7DF3;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
        }
        .btn-primary:hover {
            background-color: #3b6ce0;
        }
        .history-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        .tab-active {
            border-bottom: 2px solid #000;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        function Dashboard() {
            const [url, setUrl] = React.useState('');
            const [activeTab, setActiveTab] = React.useState('summary');
            const [selectedHistoryItem, setSelectedHistoryItem] = React.useState(null);
            const [history, setHistory] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(null);
            const [isGeneratingAudio, setIsGeneratingAudio] = React.useState(false);
            const [audioFiles, setAudioFiles] = React.useState([]);
            const audioRef = React.useRef(null);
            const [currentAudioIndex, setCurrentAudioIndex] = React.useState(0);

            React.useEffect(() => {
                fetchHistory();
            }, []);

            const fetchHistory = async () => {
                try {
                    const response = await fetch('/api/history');
                    if (!response.ok) {
                        throw new Error('Failed to fetch history');
                    }
                    const data = await response.json();
                    setHistory(data);
                } catch (error) {
                    console.error('Error fetching history:', error);
                    setError('Failed to load history');
                } finally {
                    setLoading(false);
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!url.trim()) return;

                try {
                    const response = await fetch(`/api/process/episode?url=${encodeURIComponent(url)}`, {
                        method: 'POST'
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to process episode');
                    }

                    // Clear input and refresh history
                    setUrl('');
                    fetchHistory();
                } catch (error) {
                    console.error('Error processing episode:', error);
                    setError('Failed to process episode');
                }
            };

            const handleHistoryItemClick = async (item) => {
                setSelectedHistoryItem(item);
                try {
                    // Fetch both summary and transcript
                    const [summaryResponse, transcriptResponse] = await Promise.all([
                        fetch(`/api/summary/${encodeURIComponent(item.url)}`),
                        fetch(`/api/transcript/${encodeURIComponent(item.url)}`)
                    ]);

                    const summaryData = summaryResponse.ok ? await summaryResponse.json() : null;
                    const transcriptData = transcriptResponse.ok ? await transcriptResponse.json() : null;

                    setSelectedHistoryItem({
                        ...item,
                        summary: summaryData && summaryData.summary ? summaryData.summary : null,
                        transcript: transcriptData && transcriptData.transcript ? transcriptData.transcript : null
                    });
                } catch (error) {
                    console.error('Error fetching data:', error);
                    setError('Failed to load episode data');
                }
            };

            const handleReadOutLoud = async () => {
                if (!selectedHistoryItem || !selectedHistoryItem.id) return;
                
                setIsGeneratingAudio(true);
                try {
                    const response = await fetch(`/api/tts/playlist/${encodeURIComponent(selectedHistoryItem.id)}`);
                    if (!response.ok) {
                        throw new Error('Failed to generate audio');
                    }
                    
                    const data = await response.json();
                    if (data.audio_files && data.audio_files.length > 0) {
                        setAudioFiles(data.audio_files);
                        setCurrentAudioIndex(0);
                        
                        // Start playing the first file
                        if (audioRef.current) {
                            audioRef.current.src = data.audio_files[0].url;
                            audioRef.current.play();
                        }
                    }
                } catch (error) {
                    console.error('Error generating audio:', error);
                    setError('Failed to generate audio');
                } finally {
                    setIsGeneratingAudio(false);
                }
            };

            const handleAudioEnded = () => {
                if (currentAudioIndex < audioFiles.length - 1) {
                    setCurrentAudioIndex(prev => {
                        const nextIndex = prev + 1;
                        if (audioRef.current) {
                            audioRef.current.src = audioFiles[nextIndex].url;
                            audioRef.current.play();
                        }
                        return nextIndex;
                    });
                }
            };

            const renderSummaryContent = (summary) => {
                if (!summary) {
                    return <div className="text-gray-500">No summary available</div>;
                }

                return (
                    <div className="space-y-6">
                        {summary.comprehensive_summary && (
                            <div>
                                <h3 className="text-lg font-medium mb-2">Comprehensive Summary</h3>
                                <p className="text-gray-600">{summary.comprehensive_summary}</p>
                            </div>
                        )}
                        
                        {summary.key_insights && Array.isArray(summary.key_insights) && summary.key_insights.length > 0 && (
                            <div>
                                <h3 className="text-lg font-medium mb-2">Key Insights</h3>
                                <ul className="space-y-2 text-gray-600">
                                    {summary.key_insights.map((point, index) => (
                                        <li key={index}>• {point}</li>
                                    ))}
                                </ul>
                            </div>
                        )}

                        {summary.action_items && Array.isArray(summary.action_items) && summary.action_items.length > 0 && (
                            <div>
                                <h3 className="text-lg font-medium mb-2">Action Items</h3>
                                <ul className="space-y-2 text-gray-600">
                                    {summary.action_items.map((item, index) => (
                                        <li key={index}>• {item}</li>
                                    ))}
                                </ul>
                            </div>
                        )}
                    </div>
                );
            };

            return (
                <div className="max-w-6xl mx-auto p-6">
                    <div className="grid grid-cols-2 gap-8">
                        {/* Left Column */}
                        <div>
                            <h1 className="text-2xl font-semibold mb-6">Podcast summary</h1>
                            
                            <div className="bg-white p-6 rounded-lg shadow-sm mb-8">
                                <input
                                    type="text"
                                    placeholder="Paste the episode URL"
                                    value={url}
                                    onChange={(e) => setUrl(e.target.value)}
                                    className="input-field"
                                />
                                <button onClick={handleSubmit} className="btn-primary">
                                    Summarize
                                </button>
                            </div>

                            <div>
                                <h2 className="text-xl font-semibold mb-4">History</h2>
                                <div className="space-y-2">
                                    {loading ? (
                                        <div className="text-gray-500">Loading history...</div>
                                    ) : error ? (
                                        <div className="text-red-500">{error}</div>
                                    ) : history.length === 0 ? (
                                        <div className="text-gray-500">No episodes processed yet</div>
                                    ) : (
                                        history.map(item => (
                                            <div 
                                                key={item.id} 
                                                className={`history-item cursor-pointer hover:bg-gray-50 ${selectedHistoryItem && selectedHistoryItem.id === item.id ? 'bg-gray-50' : ''}`}
                                                onClick={() => handleHistoryItemClick(item)}
                                            >
                                                <div className="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
                                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
                                                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clipRule="evenodd" />
                                                    </svg>
                                                </div>
                                                <div>
                                                    <div className="font-medium">{item.title || 'Untitled Episode'}</div>
                                                    <div className="text-sm text-gray-500">
                                                        {new Date(item.processed_at).toLocaleDateString()}
                                                    </div>
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Right Column */}
                        <div className="bg-white p-6 rounded-lg shadow-sm">
                            <div className="flex gap-8 mb-6">
                                <button 
                                    className={`pb-2 ${activeTab === 'original' ? 'tab-active' : ''}`}
                                    onClick={() => setActiveTab('original')}
                                >
                                    Original Content
                                </button>
                                <button 
                                    className={`pb-2 ${activeTab === 'summary' ? 'tab-active' : ''}`}
                                    onClick={() => setActiveTab('summary')}
                                >
                                    Summary
                                </button>
                            </div>

                            {selectedHistoryItem ? (
                                <div className="mb-6">
                                    <h2 className="text-xl font-semibold mb-4">
                                        {activeTab === 'original' ? 'Original Content' : 'Episode Summary'}
                                    </h2>
                                    
                                    {activeTab === 'summary' && (
                                        <div>
                                            <button 
                                                onClick={handleReadOutLoud}
                                                disabled={isGeneratingAudio}
                                                className={`btn-primary flex items-center justify-center gap-2 mb-6 ${isGeneratingAudio ? 'opacity-75 cursor-not-allowed' : ''}`}
                                            >
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fillRule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414z" clipRule="evenodd" />
                                                </svg>
                                                {isGeneratingAudio ? 'Generating audio...' : 'Read out loud'}
                                            </button>
                                            
                                            {audioFiles.length > 0 && (
                                                <div className="mb-6">
                                                    <audio 
                                                        ref={audioRef}
                                                        className="w-full" 
                                                        controls
                                                        onEnded={handleAudioEnded}
                                                    >
                                                        Your browser does not support the audio element.
                                                    </audio>
                                                    <div className="text-sm text-gray-500 mt-1">
                                                        Playing section {currentAudioIndex + 1} of {audioFiles.length}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {activeTab === 'original' ? (
                                        selectedHistoryItem.transcript ? (
                                            <div className="text-gray-600 whitespace-pre-wrap font-mono text-sm">
                                                {selectedHistoryItem.transcript}
                                            </div>
                                        ) : (
                                            <div className="text-gray-500">Loading transcript...</div>
                                        )
                                    ) : (
                                        selectedHistoryItem.summary ? (
                                            renderSummaryContent(selectedHistoryItem.summary)
                                        ) : (
                                            <div className="text-gray-500">Loading summary...</div>
                                        )
                                    )}
                                </div>
                            ) : (
                                <div className="flex items-center justify-center h-64 text-gray-500">
                                    Select a podcast from history to view its content
                                </div>
                            )}
                        </div>
                    </div>
                    
                    {/* Hidden audio element for TTS playback */}
                    <audio 
                        ref={audioRef}
                        className="hidden"
                        onEnded={handleAudioEnded}
                    >
                        Your browser does not support the audio element.
                    </audio>
                </div>
            );
        }

        function App() {
            return (
                <div className="min-h-screen">
                    <main>
                        <Dashboard />
                    </main>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html> 